﻿
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grade Submission</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f7f9;
            color: #333;
            height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 50px auto;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            background-image: url('../Image/m.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            background-color: rgba(255, 255, 255, 0.8); /* שקיפות לטופס */
        }

        h1 {
            color: #333;
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
        }

        .logout {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        #teacherName {
            font-size: 18px;
            color: #6c757d; /* צבע אפור כהה ורך */
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1); /* צל עדין */
            letter-spacing: 0.5px; /* רווח קטן בין האותיות */
            text-transform: capitalize; /* אות ראשונה גדולה בשפה */
            background: transparent; /* רקע שקוף */
            padding: 8px 15px; /* ריפוד קטן ונעים */
            border-radius: 10px; /* פינות מעוגלות עדינות */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* צללית רכה */
            transition: transform 0.2s ease-in-out, color 0.2s ease; /* אנימציה רכה */
            text-align: center; /* טקסט ממורכז */
            font-weight: bold;
        }

            #teacherName:hover {
                color: black; /* שינוי צבע קל לכחול */
                transform: scale(1.05); /* הגדלה קלה של הטקסט */
            }

        button {
            background: linear-gradient(135deg, #A67C52, #8B5E3C);
            color: white;
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.06);
            transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
            text-align: center;
        }

            button:hover {
                background-color: #004d40;
                transform: scale(1.05);
            }

            button:active {
                background-color: #00332f;
                transform: scale(1);
            }
        #logoutBtn {
            padding: 10px 20px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

            #logoutBtn:hover {
                background-color: #c82333;
            }


        #backButton {
            padding: 10px 20px;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

            #backButton:hover {
                background-color: #5a6268;
            }
        label {
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }

        input[type="text"], select {
            width: 100%;
            padding: 19px;
            margin: 10px 0;
            border: 1px solid #D2B48C;
            border-radius: 8px;
            box-sizing: border-box;
            box-sizing: border-box; /* להתחשב בפדינג ובגבול */

            font-size: 16px;
        }
            input[type="text"]:focus,
            input[type="datetime-local"]:focus,
            select:focus {
                border-color: #D2B48C;
                outline: none;
            }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
        }

        table, th, td {
            border: 1px solid #D2B48C;
            justify-content: center; /* למרכז את התוכן אופקית */
            align-items: center;
            padding: 10px;
            margin-top: 40px; /* מוסיף מרווח של 20 פיקסלים מלמעלה */
        }
           


        th {
            background-color: #8B5E3C;
            color: white;
        }


      

        #submitGrades {
            padding: 12px 25px;
            background-color: #6c757d; /* חום אפור */
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

            #submitGrades:hover {
                background-color: #5a6268; /* כהה יותר */
            }

            #submitGrades:active {
                background-color: #454d52; /* כהה בהרבה */
                transform: scale(0.98);
            }

        #responseMessage {
            margin-top: 20px;
            color: red;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logout">
            <span id="teacherName"></span>
            <div>
                <button id="backButton" onclick="goBack()">Go Back</button>
                <button id="logoutBtn">Logout</button>
            </div>
        </div>

        <div class="contanier">
            <h1>Grade Submission Page</h1>

            <label for="courseSelect">Select Course:</label>
            <select id="courseSelect">
                <option value="">--Select Course--</option>
            </select>

            <label for="assignmentSelect">Select Assignment:</label>
            <select id="assignmentSelect">
                <option value="">--Select Assignment--</option>
            </select>

            <div id="studentsContainer" class="hidden">
                <h3>Student Grade and Feedback</h3>
                <table id="studentContainer">
                    <thead>
                        <tr>
                            <th>Student Name</th>
                            <th>Grade</th>
                            <th>Feedback</th>
                        </tr>
                    </thead>
                    <tbody id="studentsTable">
                    </tbody>
                </table>

                <button id="submitGrades">Submit Grades</button>

                <div id="responseMessage"></div>
            </div>
        </div>
    </div>
        

    <script>
        // פונקציה להתנתקות
        document.getElementById('logoutBtn').addEventListener('click', function () {
            localStorage.clear();
            window.location.href = "Home.html";
        });

        const teacherId = localStorage.getItem('Id');
        const courseSelect = document.getElementById('courseSelect');
        const assignmentSelect = document.getElementById('assignmentSelect');
        const studentsTable = document.getElementById('studentsTable');
        let selectedCourseId = null; // משתנה גלובלי עבור selectedCourseId
        let selectedAssignmentId = null; // משתנה גלובלי עבור selectedAssignmentId

        // פונקציה לטעינת המידע של המורה
        async function loadTeacherInfo() {
            if (!teacherId) {
                document.getElementById('responseMessage').textContent = 'Teacher ID is not available.';
                return;
            }

            try {
                const response = await fetch(`http://localhost:7012/api/Teachers/${teacherId}`);
                if (!response.ok) {
                    throw new Error('Failed to load teacher information.');
                }
                const teacher = await response.json();
                document.getElementById('teacherName').textContent = `Welcome, ${teacher.firstName} ${teacher.lastName}`;
            } catch (error) {
                console.error("Error fetching teacher info:", error);
                document.getElementById('responseMessage').textContent = 'An error occurred while fetching teacher info.';
            }
        }

        // פונקציה לטעינת קורסים על פי מזהה המורה
        async function loadCourses() {
            if (!teacherId) {
                document.getElementById('responseMessage').textContent = 'Teacher ID is not available.';
                return;
            }

            try {
                const response = await fetch(`http://localhost:7012/api/Courses/byTeacher/${teacherId}`);
                if (!response.ok) {
                    throw new Error('Failed to load courses.');
                }
                const data = await response.json();

                courseSelect.innerHTML = '<option value="">--Select a course--</option>';

                if (data.length > 0) {
                    data.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course.courseId;
                        option.textContent = course.courseName;
                        courseSelect.appendChild(option);
                    });
                } else {
                    courseSelect.innerHTML = '<option value="">No courses available</option>';
                }
            } catch (error) {
                console.error("Error fetching courses:", error);
                document.getElementById('responseMessage').textContent = 'An error occurred while fetching courses.';
            }
        }

        // מאזין לבחירת קורס לטעינת מטלות בהתאם
        courseSelect.addEventListener('change', async function () {
            selectedCourseId = this.value; // שמור את selectedCourseId
            console.log(selectedCourseId);

            if (selectedCourseId) {
                try {
                    const response = await fetch(`http://localhost:7012/api/Assignment/GetAssignmentsByCourse/${selectedCourseId}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const assignments = await response.json();
                    console.log('Fetched assignments:', assignments);

                    // Clear previous assignments
                    assignmentSelect.innerHTML = '<option value="">--Select Assignment--</option>';

                    // Populate new assignments
                    assignments.forEach(assignment => {
                        const option = document.createElement('option');
                        option.value = assignment.id; // שמור את ה-ID של המטלה
                        option.textContent = assignment.title ? assignment.title : 'Unnamed Assignment';
                        assignmentSelect.appendChild(option);
                    });
                } catch (error) {
                    console.error('Error loading assignments:', error);
                    alert('Failed to load assignments. Please check the console for more details.');
                }
            } else {
                assignmentSelect.innerHTML = '<option value="">--Select Assignment--</option>'; // לנקות את המטלות אם לא נבחר קורס
            }
        });

        // Load students and grades when an assignment is selected
        assignmentSelect.addEventListener('change', async function () {
            selectedAssignmentId = this.value; // שמור את selectedAssignmentId
            const selectedAssignmentTitle = this.options[this.selectedIndex].text; // קבל את שם המטלה
            console.log('Selected Assignment Title:', selectedAssignmentTitle);
            console.log('Selected Assignment Title:', selectedCourseId);

            if (selectedCourseId && selectedAssignmentId) {

                try {
                    const response2 = await fetch(`http://localhost:7012/api/AssignmentSubmission/submissions/course/${selectedCourseId}/assignment/${selectedAssignmentTitle}`);

                    if (!response2.ok) {
                        throw new Error('Failed to load students.');
                    }

                    const submissions = await response2.json(); // החלף עם response2
                    console.log('Fetched submissions:', submissions); // בדוק מה יש ב-submissions


                    submissions.forEach(submission => {
                        const row = document.createElement('tr');

                        const nameCell = document.createElement('td');
                        nameCell.textContent = submission.studentName; // השתמש בשם הסטודנט מתוך ה-DTO
                        row.appendChild(nameCell);

                        const gradeCell = document.createElement('td');
                        const gradeInput = document.createElement('input');
                        gradeInput.type = 'text';
                        gradeInput.value = submission.grade || '';

                        gradeInput.setAttribute('data-original-grade', submission.grade || ''); // שמירת הציון המקורי
                        row.appendChild(gradeCell.appendChild(gradeInput));

                        const feedbackCell = document.createElement('td');
                        const feedbackInput = document.createElement('input');
                        feedbackInput.type = 'text';
                        feedbackInput.value = submission.feedback || ''; // הצג את הפידבק
                        feedbackCell.appendChild(feedbackInput);
                        row.appendChild(feedbackCell);

                        studentsTable.appendChild(row);

                        // Add data attributes for later usage
                        row.dataset.studentId = submission.studentId; // השתמש ב-ID של הסטודנט מתוך ה-DTO
                        row.dataset.assignmentId = selectedAssignmentId; // השתמש ב-ID של המטלה שנבחרה
                    });
                } catch (error) {
                    console.error('Error loading students:', error);
                }

            }
        });


        const fetchExamSubmissionId = async (studentId, selectedAssignmentId) => {
            try {
                const response = await fetch(`http://localhost:7012/api/AssignmentSubmission/student/${studentId}/assignment/${selectedAssignmentId}`);
                if (!response.ok) {
                    throw new Error(`Failed to fetch ExamSubmission for student ${studentId} and exam ${selectedAssignmentId}`);
                }
                const assiSubmissionId = await response.json();
                return assiSubmissionId;
            } catch (error) {
                console.error(`Error fetching assiSubmissionId:`, error);
                return null;
            }
        };

        // מאזין עבור כפתור שליחת הציונים
        document.getElementById('submitGrades').addEventListener('click', async function () {
            const rows = document.querySelectorAll('#studentsTable tr');
            const promises = [];

            rows.forEach(row => {
                const studentId = row.getAttribute('data-student-id');
                const gradeInput = row.querySelector('input[type="number"]');
                const feedbackInput = row.querySelector('input[type="text"]');
                const originalGrade = gradeInput.getAttribute('data-original-grade');
                const originalFeedback = feedbackInput.getAttribute('data-original-feedback');
                const gradeValue = gradeInput.value;
                const feedbackValue = feedbackInput.value;

                // רק אם יש שינוי בנתונים המקוריים
                if (gradeValue !== originalGrade || feedbackValue !== originalFeedback) {
                    promises.push(updateGrade(studentId, selectedAssignmentId, gradeValue, feedbackValue));
                }
            });

            try {
                await Promise.all(promises);
                alert('Grades and feedback updated successfully!');
            } catch (error) {
                document.getElementById('responseMessage').textContent = 'An error occurred while submitting grades.';
            }
        });


        // פונקציה לעדכון ציון ופידבק לסטודנט
        async function updateGrade(studentId, selectedAssignmentId, grade, feedback) {
            const assiSubmissionId = await fetchExamSubmissionId(studentId, selectedAssignmentId);

            if (!assiSubmissionId) {
                console.error("ExamSubmissionId not found");
                return;
            }

            const gradeData = {
                FilePath: "", // ערך ברירת מחדל (מחרוזת ריקה)
                StudentName: "",
                AssignmentSubmissionId: assiSubmissionId,
                Grade: grade,
                Feedback: feedback
            };

            const response1 = await fetch(`http://localhost:7012/api/AssignmentSubmission/course/${selectedCourseId}/assignment/${selectedAssignmentId}/student/${studentId}/grade`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(gradeData)
            });

            if (!response1.ok) {
                const errorText = await response1.text(); // לקרוא את גוף התגובה במקרה של שגיאה
                console.error(`Failed to update grade for student ${studentId}: ${response1.status} - ${errorText}`);
            } else {
                console.log(`Grade updated successfully for student ${studentId}`);
            }

        }

        //חזרה לדף אחורה
        function goBack() {
            window.history.back();
        }


        // Initial load of courses
        loadCourses();
        loadTeacherInfo();  // Load teacher information at the beginning
    </script>
</body>
</html>